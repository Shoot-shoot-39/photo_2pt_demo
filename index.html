<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å†™çœŸã‹ã‚‰æ–¹ä½ç·šã‚’æç”»ï¼ˆåœ°ç†é™¢åœ°å›³é€£å‹•ï¼‰</title>
<style>
  body { font-family: sans-serif; margin: 1em; }
  #canvasContainer { position: relative; }
  canvas { max-width: 100%; border: 1px solid #ccc; cursor: crosshair; }
  #map { height: 500px; margin-top: 1em; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
</head>
<body>
<h2>ğŸ“· å†™çœŸã‹ã‚‰æ–¹ä½ç·šã‚’æç”»ï¼ˆåœ°ç†é™¢åœ°å›³é€£å‹•ï¼‰</h2>
<input type="file" id="fileInput" accept="image/*"><br><br>
<canvas id="photoCanvas"></canvas>
<div id="map"></div>

<script>
const canvas = document.getElementById('photoCanvas');
const ctx = canvas.getContext('2d');
let img = new Image();
let points = [];
let exifData = {};
let photoLat = null, photoLon = null, photoDir = null, focal35 = null;

// Leaflet åœ°ç†é™¢åœ°å›³åˆæœŸåŒ–
const map = L.map('map').setView([35.681236, 139.767125], 5);
L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
  attribution: 'åœ°ç†é™¢åœ°å›³'
}).addTo(map);

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚
fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    img.onload = function() {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
    }
    img.src = evt.target.result;
  }
  reader.readAsDataURL(file);

  EXIF.getData(file, function() {
    exifData = EXIF.getAllTags(this);
    photoLat = EXIF.getTag(this, 'GPSLatitude');
    photoLon = EXIF.getTag(this, 'GPSLongitude');
    photoDir = EXIF.getTag(this, 'GPSImgDirection');
    focal35 = EXIF.getTag(this, 'FocalLengthIn35mmFilm');

    function toDeg(arr, ref) {
      if (!arr) return null;
      let deg = arr[0] + arr[1]/60 + arr[2]/3600;
      if (ref === 'S' || ref === 'W') deg *= -1;
      return deg;
    }

    const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
    const lonRef = EXIF.getTag(this, 'GPSLongitudeRef');
    photoLat = toDeg(photoLat, latRef);
    photoLon = toDeg(photoLon, lonRef);

    console.log('EXIF:', {photoLat, photoLon, photoDir, focal35});
  });
});

canvas.addEventListener('click', e => {
  if (!img.src) return;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  points.push({x, y});

  ctx.drawImage(img, 0, 0);
  ctx.fillStyle = 'red';
  points.forEach(p => ctx.fillRect(p.x-4, p.y-4, 8, 8));

  if (points.length === 2) {
    calcAndDrawDirection();
  }
});

function calcAndDrawDirection() {
  const dx = points[1].x - points[0].x;
  const dy = points[1].y - points[0].y;
  const anglePx = Math.atan2(-dx, -dy) * 180 / Math.PI; // ç”»åƒä¸Šã®è§’åº¦

  let bearing = 0;
  if (photoDir != null) {
    bearing = (photoDir + anglePx + 360) % 360;
  } else {
    bearing = (anglePx + 360) % 360;
  }

  if (photoLat && photoLon) {
    drawDirectionLine(photoLat, photoLon, bearing, 150000); // 150km
  } else {
    alert('EXIFã«GPSæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
  }

  points = [];
}

function drawDirectionLine(lat, lon, bearingDeg, dist=150000) {
  const R = 6371000;
  const brng = bearingDeg * Math.PI/180;
  const lat1 = lat * Math.PI/180;
  const lon1 = lon * Math.PI/180;
  const lat2 = Math.asin(Math.sin(lat1)*Math.cos(dist/R) + Math.cos(lat1)*Math.sin(dist/R)*Math.cos(brng));
  const lon2 = lon1 + Math.atan2(
    Math.sin(brng)*Math.sin(dist/R)*Math.cos(lat1),
    Math.cos(dist/R)-Math.sin(lat1)*Math.sin(lat2)
  );
  const endLat = lat2 * 180/Math.PI;
  const endLon = lon2 * 180/Math.PI;

  L.polyline([[lat, lon], [endLat, endLon]], {color: 'red'}).addTo(map);
  L.marker([lat, lon]).addTo(map).bindPopup('æ’®å½±ä½ç½®');
  L.marker([endLat, endLon]).addTo(map).bindPopup(`2ç‚¹ç›®æ–¹å‘ (${bearingDeg.toFixed(1)}Â°)`);
  map.setView([lat, lon], 8);
}
</script>
</body>
</html>
