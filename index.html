<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å†™çœŸæ–¹ä½ç·šãƒ„ãƒ¼ãƒ«ï¼ˆã‚¹ãƒãƒ›ç¸¦é…ç½®ï¼‹æ“ä½œãƒœã‚¿ãƒ³ï¼‰</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; }
    #imageContainer { width: 100%; text-align: center; margin-top: 10px; }
    #uploadedImage { max-width: 95%; height: auto; border: 1px solid #ccc; }
    #map { width: 95%; height: 400px; margin-top: 10px; }
    #info { width: 95%; font-size: 14px; margin: 10px 0; text-align: center; }
    input[type="file"] { margin: 10px; }
    button { margin: 5px; padding: 10px 20px; font-size: 14px; border: none; border-radius: 8px; background-color: #007bff; color: white; }
    button:active { background-color: #0056b3; }
  </style>
</head>
<body>
  <h2>ğŸ“¸ å†™çœŸæ–¹ä½ç·šãƒ„ãƒ¼ãƒ«ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰</h2>

  <input type="file" id="photoInput" accept="image/*"><br>

  <div id="imageContainer">
    <canvas id="photoCanvas"></canvas>
  </div>

  <div id="controls">
    <button id="resetPoints">ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="clearMap">åœ°å›³ç·šã‚¯ãƒªã‚¢</button>
  </div>

  <div id="info">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€<b>2ç‚¹</b>ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ–¹ä½ã‚’æ±‚ã‚ã¦ãã ã•ã„ã€‚<br>ãã®å¾Œã€åœ°å›³ä¸Šã§åŸºæº–ç‚¹ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨150kmã®æ–¹ä½ç·šã‚’æãã¾ã™ã€‚</div>

  <div id="map"></div>

  <script src="https://unpkg.com/exif-js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let img = new Image();
    let canvas = document.getElementById('photoCanvas');
    let ctx = canvas.getContext('2d');
    let points = [];
    let focal35 = 28; // iPhone SE2ç›¸å½“ã®35mmæ›ç®—ç„¦ç‚¹è·é›¢
    let gpsImgDir = null;

    document.getElementById('photoInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      EXIF.getData(file, function() {
        gpsImgDir = EXIF.getTag(this, 'GPSImgDirection');
      });
      const reader = new FileReader();
      reader.onload = ev => {
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    canvas.addEventListener('click', e => {
      if (!img.src) return;
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (canvas.width / rect.width);
      const y = (e.clientY - rect.top) * (canvas.height / rect.height);
      points.push({x, y});
      ctx.fillStyle = points.length === 1 ? 'red' : 'blue';
      ctx.beginPath();
      ctx.arc(x, y, 8, 0, Math.PI * 2);
      ctx.fill();
      if (points.length === 2) calculateAngle();
    });

    let relativeAngle = null;

    function calculateAngle() {
      const dx = points[1].x - points[0].x;
      const fov = 60; // iPhone SE2 æ¨ªæ–¹å‘ç”»è§’ï¼ˆæ¦‚ç®—ï¼‰
      const anglePerPixel = fov / canvas.width;
      relativeAngle = dx * anglePerPixel;
      alert(`ç›¸å¯¾è§’åº¦: ${relativeAngle.toFixed(2)}Â°`);
    }

    // Leafletåœ°å›³
    const map = L.map('map').setView([35.6812, 139.7671], 8);
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
      attribution: 'åœ°ç†é™¢åœ°å›³'
    }).addTo(map);

    let drawnLines = [];

    function drawDirectionLine(lat, lon, bearing, lengthMeters) {
      const R = 6371000;
      const brngRad = bearing * Math.PI / 180;
      const latRad = lat * Math.PI / 180;
      const lonRad = lon * Math.PI / 180;
      const newLat = Math.asin(Math.sin(latRad) * Math.cos(lengthMeters / R) + Math.cos(latRad) * Math.sin(lengthMeters / R) * Math.cos(brngRad));
      const newLon = lonRad + Math.atan2(Math.sin(brngRad) * Math.sin(lengthMeters / R) * Math.cos(latRad), Math.cos(lengthMeters / R) - Math.sin(latRad) * Math.sin(newLat));
      const endLat = newLat * 180 / Math.PI;
      const endLon = newLon * 180 / Math.PI;
      const line = L.polyline([[lat, lon], [endLat, endLon]], {color: 'red'}).addTo(map);
      drawnLines.push(line);
    }

    map.on('click', e => {
      if (relativeAngle == null) {
        alert('å…ˆã«ç”»åƒä¸Šã§2ç‚¹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      const baseLat = e.latlng.lat;
      const baseLon = e.latlng.lng;
      const baseDir = gpsImgDir || 0;
      const finalBearing = (baseDir + relativeAngle + 360) % 360;
      drawDirectionLine(baseLat, baseLon, finalBearing, 150000);
    });

    document.getElementById('resetPoints').addEventListener('click', () => {
      points = [];
      relativeAngle = null;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);
      alert('ç”»åƒä¸Šã®ç‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
    });

    document.getElementById('clearMap').addEventListener('click', () => {
      drawnLines.forEach(line => map.removeLayer(line));
      drawnLines = [];
      alert('åœ°å›³ä¸Šã®ç·šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
    });
  </script>
</body>
</html>
