<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å†™çœŸæ–¹ä½ç·šãƒ„ãƒ¼ãƒ«ï¼ˆæ’®å½±ä½ç½®å›ºå®šï¼‹é«˜è§£åƒåº¦å¯¾å¿œï¼‰</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; }
    #imageContainer { width: 100%; text-align: center; margin-top: 10px; }
    #photoCanvas { width: 95%; height: auto; border: 1px solid #ccc; max-width: 800px; }
    #map { width: 95%; height: 400px; margin-top: 10px; }
    #info { width: 95%; font-size: 14px; margin: 10px 0; text-align: center; }
    input[type="file"] { margin: 10px; }
    button { margin: 5px; padding: 10px 20px; font-size: 14px; border: none; border-radius: 8px; background-color: #007bff; color: white; }
    button:active { background-color: #0056b3; }
  </style>
</head>
<body>
  <h2>ğŸ“¸ å†™çœŸæ–¹ä½ç·šãƒ„ãƒ¼ãƒ«ï¼ˆæ’®å½±ä½ç½®å›ºå®šï¼‹é«˜è§£åƒåº¦å¯¾å¿œï¼‰</h2>

  <input type="file" id="photoInput" accept="image/*"><br>

  <div id="imageContainer">
    <canvas id="photoCanvas"></canvas>
  </div>

  <div id="controls">
    <button id="resetPoints">ç”»åƒä¸Šã®ç‚¹ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="clearMap">åœ°å›³ç·šã‚¯ãƒªã‚¢</button>
    <button id="fullReset">ğŸ§¹ å…¨ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <div id="info">
    ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€<b>2ç‚¹</b>ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ç›¸å¯¾è§’åº¦ã‚’æ±‚ã‚ã¦ãã ã•ã„ã€‚<br>
    åœ°å›³ã¯æ’®å½±ä½ç½®ã‚’ä¸­å¿ƒã«è¡¨ç¤ºã—ã¾ã™ã€‚<br>
    åœ°å›³ä¸Šã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€<b>1ç‚¹ç›®ã®ä½ç½®</b>ã‚’æŒ‡å®šã™ã‚‹ã¨150kmæ–¹ä½ç·šã‚’æãã¾ã™ã€‚
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/exif-js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let img = new Image();
    let canvas = document.getElementById('photoCanvas');
    let ctx = canvas.getContext('2d');
    let points = [];
    let focal35 = 28;
    let gpsImgDir = 0;
    let photoLat = null;
    let photoLon = null;

    const map = L.map('map').setView([35.6812, 139.7671], 8);
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', { attribution: 'åœ°ç†é™¢åœ°å›³' }).addTo(map);
    let drawnLines = [];
    let markers = [];

    document.getElementById('photoInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      EXIF.getData(file, function() {
        const hd = EXIF.getTag(this, 'GPSImgDirection');
        gpsImgDir = (typeof hd === 'object' && hd !== null && hd.numerator!==undefined) ? (hd.numerator/hd.denominator) : (hd || 0);
        const lat = EXIF.getTag(this, 'GPSLatitude');
        const lon = EXIF.getTag(this, 'GPSLongitude');
        const latRef = EXIF.getTag(this, 'GPSLatitudeRef') || 'N';
        const lonRef = EXIF.getTag(this, 'GPSLongitudeRef') || 'E';
        if (lat && lon) {
          function toNum(v){ return (v[0] && v[0].numerator!==undefined) ? v.map(x=>x.numerator/x.denominator) : v; }
          const la = toNum(lat), lo = toNum(lon);
          photoLat = (la[0] + la[1] / 60 + la[2] / 3600) * (latRef === 'S' ? -1 : 1);
          photoLon = (lo[0] + lo[1] / 60 + lo[2] / 3600) * (lonRef === 'W' ? -1 : 1);
          map.setView([photoLat, photoLon], 12);
          const m = L.marker([photoLat, photoLon]).addTo(map).bindPopup('ğŸ“· æ’®å½±ä½ç½®');
          markers.push(m);
        }
        const f35 = EXIF.getTag(this, 'FocalLengthIn35mmFilm');
        if(f35) focal35 = parseFloat(f35);
      });

      const reader = new FileReader();
      reader.onload = ev => {
        img.onload = () => {
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          ctx.drawImage(img, 0, 0);
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    canvas.addEventListener('click', e => {
      if (!img.src) return;
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;
      if(points.length >= 2) points = [];
      points.push({x, y});
      drawImageWithMarkers();
      if (points.length === 2) calculateAngleAndShow();
    });

    function drawImageWithMarkers(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img, 0, 0);
      points.forEach((p,i)=>{
        ctx.fillStyle = i===0 ? 'red' : 'blue';
        ctx.beginPath(); ctx.arc(p.x, p.y, 20, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.font='36px sans-serif'; ctx.fillText(String(i+1), p.x-10, p.y+10);
      });
    }

    let camAngles = {a1:0, a2:0};
    let relativeAngle = null;

    function calculateAngleAndShow(){
      const f35 = focal35 || 28;
      const hfov = 2 * Math.atan(36 / (2 * f35));
      const fx_pixels = (canvas.width / 2) / Math.tan(hfov / 2);
      const cx = canvas.width / 2;
      const x1 = points[0].x; const x2 = points[1].x;
      const ang1 = Math.atan2(x1 - cx, fx_pixels) * 180 / Math.PI;
      const ang2 = Math.atan2(x2 - cx, fx_pixels) * 180 / Math.PI;
      camAngles.a1 = ang1; camAngles.a2 = ang2;
      relativeAngle = ang2 - ang1;
      alert(`æ°´å¹³è§’ï¼š${relativeAngle.toFixed(3)}Â°`);
    }

    function computeGeoBearing(lat1, lon1, lat2, lon2){
      const Ï†1 = lat1 * Math.PI/180; const Ï†2 = lat2 * Math.PI/180;
      const Î»1 = lon1 * Math.PI/180; const Î»2 = lon2 * Math.PI/180;
      const y = Math.sin(Î»2-Î»1)*Math.cos(Ï†2);
      const x = Math.cos(Ï†1)*Math.sin(Ï†2) - Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2-Î»1);
      const Î¸ = Math.atan2(y,x);
      return (Î¸*180/Math.PI + 360) % 360;
    }

    function drawDirectionLine(lat, lon, bearing, lengthMeters) {
      const R = 6371000;
      const brngRad = bearing * Math.PI / 180;
      const latRad = lat * Math.PI / 180;
      const lonRad = lon * Math.PI / 180;
      const newLat = Math.asin(Math.sin(latRad) * Math.cos(lengthMeters / R) + Math.cos(latRad) * Math.sin(lengthMeters / R) * Math.cos(brngRad));
      const newLon = lonRad + Math.atan2(Math.sin(brngRad) * Math.sin(lengthMeters / R) * Math.cos(latRad), Math.cos(lengthMeters / R) - Math.sin(latRad) * Math.sin(newLat));
      const endLat = newLat * 180 / Math.PI;
      const endLon = newLon * 180 / Math.PI;
      const line = L.polyline([[lat, lon], [endLat, endLon]], {color: 'red'}).addTo(map);
      drawnLines.push(line);
    }

    map.on('click', e => {
      if (points.length < 2) { alert('ã¾ãšç”»åƒä¸Šã§2ç‚¹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„'); return; }
      if (photoLat == null || photoLon == null) { alert('æ’®å½±ä½ç½®ãŒEXIFã«ã‚ã‚Šã¾ã›ã‚“'); return; }
      const userLat = e.latlng.lat; const userLon = e.latlng.lng;
      const bearingPhotoToP1 = computeGeoBearing(photoLat, photoLon, userLat, userLon);
      // ä¿®æ­£ç‰ˆï¼šç›¸å¯¾è§’åº¦ã®ç¬¦å·ã‚’æ­£ã—ãæ‰±ã†
      const absoluteBearing = (bearingPhotoToP1 - (camAngles.a1 - camAngles.a2) + 360) % 360;
      drawDirectionLine(photoLat, photoLon, absoluteBearing, 150000);
      const m = L.marker([userLat, userLon]).addTo(map).bindPopup('ç‚¹1ã®åœ°ä¸Šä½ç½®').openPopup();
      markers.push(m);
    });

    document.getElementById('resetPoints').addEventListener('click', () => {
      points = []; relativeAngle = null; camAngles = {a1:0,a2:0};
      if(img.src) { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img, 0, 0); }
    });

    document.getElementById('clearMap').addEventListener('click', () => {
      drawnLines.forEach(line => map.removeLayer(line));
      markers.forEach(m => map.removeLayer(m));
      drawnLines = []; markers = [];
    });

    document.getElementById('fullReset').addEventListener('click', () => {
      points = []; relativeAngle = null; camAngles = {a1:0,a2:0};
      photoLat = null; photoLon = null; gpsImgDir = 0;
      drawnLines.forEach(line => map.removeLayer(line));
      markers.forEach(m => map.removeLayer(m));
      drawnLines = []; markers = [];
      ctx.clearRect(0,0,canvas.width,canvas.height);
      canvas.width = canvas.height = 0;
      document.getElementById('photoInput').value = '';
      map.setView([35.6812, 139.7671], 8);
      alert('ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
    });
  </script>
</body>
</html>